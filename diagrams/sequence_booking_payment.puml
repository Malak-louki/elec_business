@startuml sequence_booking_payment

title Flux RÃ©servation et Paiement - Elec Business

actor "Utilisateur" as User
participant "Frontend\nAngular" as Frontend
participant "Security\nFilter" as Security
participant "Booking\nController" as BookingCtrl
participant "Booking\nService" as BookingSvc
participant "Booking\nRepository" as BookingRepo
participant "Payment\nController" as PaymentCtrl
participant "Payment\nService" as PaymentSvc
database "MySQL" as DB

== CrÃ©ation de la rÃ©servation ==

User -> Frontend: SÃ©lectionne crÃ©neau
activate Frontend

Frontend -> BookingCtrl: POST /api/bookings\n+ JWT Token
activate BookingCtrl

Security -> Security: Valide JWT\nCharge User

BookingCtrl -> BookingSvc: createBooking(request, user)
activate BookingSvc

BookingSvc -> BookingSvc: Valide dates\n(â‰¥1h, â‰¤168h)

BookingSvc -> BookingRepo: VÃ©rifie conflits\nexistsConflictingBooking()
activate BookingRepo
BookingRepo -> DB: SELECT COUNT(*)\nWHERE status IN\n('PENDING','CONFIRMED')
return hasConflict

alt CrÃ©neau indisponible
    BookingSvc --> BookingCtrl: throw BookingConflictException
    BookingCtrl --> Frontend: 409 Conflict
    Frontend --> User: âŒ CrÃ©neau dÃ©jÃ  rÃ©servÃ©
end

BookingSvc -> BookingSvc: Calcule montant\n(prix Ã— heures arrondies)

BookingSvc -> BookingRepo: save(booking)\nstatus=PENDING\nexpiresAt=now+15min
BookingRepo -> DB: INSERT booking
return booking (PENDING)

BookingSvc --> BookingCtrl: BookingResponseDto
deactivate BookingSvc
BookingCtrl --> Frontend: 201 Created
deactivate BookingCtrl

Frontend --> User: âœ… RÃ©servation crÃ©Ã©e\nâ± Expire dans 15 min
deactivate Frontend

== Simulation du paiement ==

User -> Frontend: Clique "Payer"
activate Frontend

Frontend -> PaymentCtrl: POST /api/payments/simulate\n{bookingId}
activate PaymentCtrl

PaymentCtrl -> PaymentSvc: simulatePayment(request, user)
activate PaymentSvc

PaymentSvc -> BookingRepo: findById(bookingId)
BookingRepo -> DB: SELECT * FROM booking
return booking

alt Booking invalide ou expirÃ©
    PaymentSvc --> PaymentCtrl: throw IllegalArgumentException
    PaymentCtrl --> Frontend: 400 Bad Request
    Frontend --> User: âŒ RÃ©servation invalide
end

PaymentSvc -> PaymentSvc: GÃ©nÃ¨re ID simulation\n"pi_sim_" + UUID

note over PaymentSvc
  **Mode Simulation**
  Pas d'appel API Stripe
  
  simulateSuccess=true â†’ SUCCEEDED
  simulateSuccess=false â†’ FAILED
end note

alt Paiement rÃ©ussi
    PaymentSvc -> DB: INSERT payment\nstatus=SUCCEEDED
    PaymentSvc -> DB: UPDATE booking\nstatus=CONFIRMED
    
    PaymentSvc --> PaymentCtrl: PaymentResponseDto\n(SUCCEEDED)
    PaymentCtrl --> Frontend: 201 Created
    Frontend --> User: âœ… Paiement confirmÃ©\nâœ… RÃ©servation validÃ©e
    
else Paiement Ã©chouÃ©
    PaymentSvc -> DB: INSERT payment\nstatus=FAILED
    note over PaymentSvc
      Booking reste PENDING
      (peut rÃ©essayer)
    end note
    
    PaymentSvc --> PaymentCtrl: PaymentResponseDto\n(FAILED)
    PaymentCtrl --> Frontend: 201 Created
    Frontend --> User: âŒ Paiement Ã©chouÃ©\nğŸ”„ RÃ©essayer
end

deactivate PaymentSvc
deactivate PaymentCtrl
deactivate Frontend

== Expiration automatique (Job) ==

note over BookingRepo, DB
  **BookingScheduler**
  ExÃ©cution toutes les 5 min
  
  SELECT * FROM booking
  WHERE status='PENDING'
    AND expires_at < NOW()
  
  â†’ UPDATE status='EXPIRED'
end note

@enduml
